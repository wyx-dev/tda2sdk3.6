/*
 *******************************************************************************
 *
 * Copyright (C) 2015 Texas Instruments Incorporated - http://www.ti.com/
 * ALL RIGHTS RESERVED
 *
 *******************************************************************************
 *
 *
 *  File: sgxRender3Dutils.c
 *
 *  Custom utilities for sgxRender3D links
 *  
 *******************************************************************************/

#include "sgxRender3DsfmUtils.h"

/*Camera Parameters for IMI lens*/

/**** Distortion Centers **************************/
/*    format: cam0_x, cam0_y, cam1_x, cam1_y, ... */
static int ldcLUT_distortionCenters[] = {640,360,640,360,640,360,640,360};

/**** LDC LUT undistorted to distorted ******/
static int ldcLUT_U2D_length = 901;
static float ldcLUT_U2D_step = 1.7453293e-03f;
static float ldcLUT_U2D_table[]= {
0.0000000e+00f,5.4428571e-01f,1.0888095e+00f,1.6333333e+00f,2.1776190e+00f,2.7221429e+00f,3.2664286e+00f,3.8109524e+00f,4.3554762e+00f,4.8997619e+00f,5.4442857e+00f,5.9888095e+00f,6.5333333e+00f,7.0778571e+00f,7.6223810e+00f,8.1671429e+00f,8.7116667e+00f,9.2561905e+00f,9.8009524e+00f,1.0345714e+01f,1.0890476e+01f,1.1435238e+01f,1.1980000e+01f,1.2524762e+01f,1.3069762e+01f,1.3614762e+01f,1.4159762e+01f,1.4704762e+01f,1.5249762e+01f,1.5794762e+01f,1.6340000e+01f,1.6885238e+01f,1.7430476e+01f,1.7975952e+01f,1.8521190e+01f,1.9066667e+01f,1.9612143e+01f,2.0157857e+01f,2.0703571e+01f,2.1249286e+01f,2.1795000e+01f,2.2340714e+01f,2.2886667e+01f,2.3432619e+01f,2.3978810e+01f,2.4525000e+01f,2.5071190e+01f,2.5617381e+01f,2.6163810e+01f,2.6710476e+01f,
2.7256905e+01f,2.7803571e+01f,2.8350238e+01f,2.8897143e+01f,2.9444048e+01f,2.9991190e+01f,3.0538333e+01f,3.1085476e+01f,3.1632857e+01f,3.2180238e+01f,3.2727619e+01f,3.3275238e+01f,3.3823095e+01f,3.4370952e+01f,3.4918810e+01f,3.5466905e+01f,3.6015238e+01f,3.6563333e+01f,3.7111905e+01f,3.7660476e+01f,3.8209048e+01f,3.8757857e+01f,3.9306667e+01f,3.9855714e+01f,4.0405000e+01f,4.0954286e+01f,4.1503571e+01f,4.2053095e+01f,4.2602857e+01f,4.3152619e+01f,4.3702619e+01f,4.4252857e+01f,4.4803095e+01f,4.5353333e+01f,4.5904048e+01f,4.6454524e+01f,4.7005476e+01f,4.7556429e+01f,4.8107619e+01f,4.8658810e+01f,4.9210238e+01f,4.9761905e+01f,5.0313571e+01f,5.0865476e+01f,5.1417619e+01f,5.1970000e+01f,5.2522381e+01f,5.3075000e+01f,5.3627619e+01f,5.4180476e+01f,
5.4733571e+01f,5.5286905e+01f,5.5840476e+01f,5.6394048e+01f,5.6947857e+01f,5.7501905e+01f,5.8055952e+01f,5.8610238e+01f,5.9164762e+01f,5.9719524e+01f,6.0274524e+01f,6.0829524e+01f,6.1385000e+01f,6.1940476e+01f,6.2496190e+01f,6.3051905e+01f,6.3608095e+01f,6.4164286e+01f,6.4720952e+01f,6.5277619e+01f,6.5834524e+01f,6.6391667e+01f,6.6948810e+01f,6.7506429e+01f,6.8064286e+01f,6.8622143e+01f,6.9180238e+01f,6.9738810e+01f,7.0297381e+01f,7.0856190e+01f,7.1415238e+01f,7.1974524e+01f,7.2534048e+01f,7.3093810e+01f,7.3653810e+01f,7.4214048e+01f,7.4774286e+01f,7.5335000e+01f,7.5895952e+01f,7.6457143e+01f,7.7018571e+01f,7.7580000e+01f,7.8141905e+01f,7.8704048e+01f,7.9266429e+01f,7.9829048e+01f,8.0391905e+01f,8.0955000e+01f,8.1518333e+01f,8.2081905e+01f,
8.2645714e+01f,8.3210000e+01f,8.3774286e+01f,8.4339048e+01f,8.4903810e+01f,8.5469048e+01f,8.6034524e+01f,8.6600238e+01f,8.7166190e+01f,8.7732381e+01f,8.8298810e+01f,8.8865714e+01f,8.9432857e+01f,9.0000000e+01f,9.0567619e+01f,9.1135714e+01f,9.1703810e+01f,9.2272143e+01f,9.2840952e+01f,9.3410000e+01f,9.3979286e+01f,9.4549048e+01f,9.5118810e+01f,9.5689048e+01f,9.6259524e+01f,9.6830238e+01f,9.7401429e+01f,9.7972619e+01f,9.8544286e+01f,9.9116429e+01f,9.9688571e+01f,1.0026119e+02f,1.0083405e+02f,1.0140738e+02f,1.0198071e+02f,1.0255476e+02f,1.0312881e+02f,1.0370333e+02f,1.0427786e+02f,1.0485310e+02f,1.0542833e+02f,1.0600405e+02f,1.0658024e+02f,1.0715667e+02f,1.0773333e+02f,1.0831024e+02f,1.0888762e+02f,1.0946524e+02f,1.1004333e+02f,1.1062167e+02f,
1.1120024e+02f,1.1177929e+02f,1.1235857e+02f,1.1293833e+02f,1.1351833e+02f,1.1409857e+02f,1.1467929e+02f,1.1526024e+02f,1.1584167e+02f,1.1642333e+02f,1.1700548e+02f,1.1758786e+02f,1.1817071e+02f,1.1875381e+02f,1.1933738e+02f,1.1992119e+02f,1.2050524e+02f,1.2109000e+02f,1.2167476e+02f,1.2226000e+02f,1.2284571e+02f,1.2343167e+02f,1.2401810e+02f,1.2460476e+02f,1.2519190e+02f,1.2577929e+02f,1.2636714e+02f,1.2695548e+02f,1.2754405e+02f,1.2813310e+02f,1.2872238e+02f,1.2931214e+02f,1.2990214e+02f,1.3049262e+02f,1.3108357e+02f,1.3167476e+02f,1.3226643e+02f,1.3285833e+02f,1.3345071e+02f,1.3404357e+02f,1.3463667e+02f,1.3523024e+02f,1.3582429e+02f,1.3641857e+02f,1.3701333e+02f,1.3760857e+02f,1.3820405e+02f,1.3880000e+02f,1.3939643e+02f,1.3999310e+02f,
1.4059024e+02f,1.4118786e+02f,1.4178595e+02f,1.4238429e+02f,1.4298310e+02f,1.4358214e+02f,1.4418190e+02f,1.4478190e+02f,1.4538238e+02f,1.4598310e+02f,1.4658429e+02f,1.4718619e+02f,1.4778810e+02f,1.4839071e+02f,1.4899357e+02f,1.4959714e+02f,1.5020071e+02f,1.5080500e+02f,1.5140976e+02f,1.5201476e+02f,1.5262024e+02f,1.5322619e+02f,1.5383262e+02f,1.5443929e+02f,1.5504667e+02f,1.5565429e+02f,1.5626238e+02f,1.5687095e+02f,1.5748000e+02f,1.5808929e+02f,1.5869929e+02f,1.5930952e+02f,1.5992024e+02f,1.6053143e+02f,1.6114310e+02f,1.6175524e+02f,1.6236786e+02f,1.6298071e+02f,1.6359429e+02f,1.6420810e+02f,1.6482238e+02f,1.6543714e+02f,1.6605262e+02f,1.6666833e+02f,1.6728452e+02f,1.6790095e+02f,1.6851810e+02f,1.6913571e+02f,1.6975381e+02f,1.7037214e+02f,
1.7099119e+02f,1.7161048e+02f,1.7223048e+02f,1.7285071e+02f,1.7347167e+02f,1.7409286e+02f,1.7471476e+02f,1.7533690e+02f,1.7595952e+02f,1.7658286e+02f,1.7720643e+02f,1.7783048e+02f,1.7845524e+02f,1.7908024e+02f,1.7970571e+02f,1.8033190e+02f,1.8095833e+02f,1.8158548e+02f,1.8221286e+02f,1.8284095e+02f,1.8346929e+02f,1.8409833e+02f,1.8472786e+02f,1.8535786e+02f,1.8598810e+02f,1.8661905e+02f,1.8725048e+02f,1.8788238e+02f,1.8851476e+02f,1.8914762e+02f,1.8978119e+02f,1.9041500e+02f,1.9104929e+02f,1.9168429e+02f,1.9231976e+02f,1.9295548e+02f,1.9359190e+02f,1.9422881e+02f,1.9486619e+02f,1.9550405e+02f,1.9614262e+02f,1.9678143e+02f,1.9742095e+02f,1.9806071e+02f,1.9870119e+02f,1.9934214e+02f,1.9998357e+02f,2.0062571e+02f,2.0126810e+02f,2.0191119e+02f,
2.0255452e+02f,2.0319857e+02f,2.0384333e+02f,2.0448833e+02f,2.0513381e+02f,2.0578000e+02f,2.0642667e+02f,2.0707381e+02f,2.0772143e+02f,2.0836952e+02f,2.0901833e+02f,2.0966762e+02f,2.1031738e+02f,2.1096762e+02f,2.1161857e+02f,2.1226976e+02f,2.1292167e+02f,2.1357405e+02f,2.1422690e+02f,2.1488048e+02f,2.1553452e+02f,2.1618905e+02f,2.1684405e+02f,2.1749976e+02f,2.1815571e+02f,2.1881238e+02f,2.1946976e+02f,2.2012738e+02f,2.2078571e+02f,2.2144452e+02f,2.2210381e+02f,2.2276381e+02f,2.2342429e+02f,2.2408524e+02f,2.2474667e+02f,2.2540881e+02f,2.2607143e+02f,2.2673452e+02f,2.2739810e+02f,2.2806238e+02f,2.2872714e+02f,2.2939262e+02f,2.3005833e+02f,2.3072476e+02f,2.3139190e+02f,2.3205929e+02f,2.3272738e+02f,2.3339595e+02f,2.3406524e+02f,2.3473500e+02f,
2.3540524e+02f,2.3607619e+02f,2.3674738e+02f,2.3741952e+02f,2.3809190e+02f,2.3876500e+02f,2.3943857e+02f,2.4011286e+02f,2.4078738e+02f,2.4146286e+02f,2.4213857e+02f,2.4281500e+02f,2.4349190e+02f,2.4416952e+02f,2.4484762e+02f,2.4552619e+02f,2.4620548e+02f,2.4688524e+02f,2.4756548e+02f,2.4824643e+02f,2.4892786e+02f,2.4961000e+02f,2.5029262e+02f,2.5097571e+02f,2.5165929e+02f,2.5234357e+02f,2.5302857e+02f,2.5371405e+02f,2.5440000e+02f,2.5508643e+02f,2.5577357e+02f,2.5646119e+02f,2.5714952e+02f,2.5783833e+02f,2.5852786e+02f,2.5921786e+02f,2.5990833e+02f,2.6059952e+02f,2.6129119e+02f,2.6198333e+02f,2.6267619e+02f,2.6336952e+02f,2.6406357e+02f,2.6475810e+02f,2.6545333e+02f,2.6614905e+02f,2.6684524e+02f,2.6754214e+02f,2.6823952e+02f,2.6893738e+02f,
2.6963619e+02f,2.7033524e+02f,2.7103500e+02f,2.7173524e+02f,2.7243619e+02f,2.7313762e+02f,2.7383976e+02f,2.7454238e+02f,2.7524548e+02f,2.7594929e+02f,2.7665357e+02f,2.7735857e+02f,2.7806405e+02f,2.7877000e+02f,2.7947667e+02f,2.8018405e+02f,2.8089190e+02f,2.8160024e+02f,2.8230929e+02f,2.8301881e+02f,2.8372905e+02f,2.8443976e+02f,2.8515095e+02f,2.8586286e+02f,2.8657548e+02f,2.8728833e+02f,2.8800214e+02f,2.8871619e+02f,2.8943119e+02f,2.9014643e+02f,2.9086238e+02f,2.9157905e+02f,2.9229619e+02f,2.9301381e+02f,2.9373214e+02f,2.9445095e+02f,2.9517048e+02f,2.9589048e+02f,2.9661119e+02f,2.9733238e+02f,2.9805405e+02f,2.9877643e+02f,2.9949952e+02f,3.0022286e+02f,3.0094714e+02f,3.0167167e+02f,3.0239714e+02f,3.0312286e+02f,3.0384929e+02f,3.0457643e+02f,
3.0530405e+02f,3.0603214e+02f,3.0676095e+02f,3.0749024e+02f,3.0822024e+02f,3.0895071e+02f,3.0968190e+02f,3.1041357e+02f,3.1114571e+02f,3.1187857e+02f,3.1261214e+02f,3.1334595e+02f,3.1408071e+02f,3.1481571e+02f,3.1555143e+02f,3.1628786e+02f,3.1702476e+02f,3.1776214e+02f,3.1850024e+02f,3.1923881e+02f,3.1997810e+02f,3.2071786e+02f,3.2145833e+02f,3.2219905e+02f,3.2294071e+02f,3.2368286e+02f,3.2442548e+02f,3.2516857e+02f,3.2591238e+02f,3.2665690e+02f,3.2740190e+02f,3.2814738e+02f,3.2889357e+02f,3.2964024e+02f,3.3038738e+02f,3.3113524e+02f,3.3188357e+02f,3.3263262e+02f,3.3338214e+02f,3.3413214e+02f,3.3488286e+02f,3.3563429e+02f,3.3638595e+02f,3.3713833e+02f,3.3789119e+02f,3.3864476e+02f,3.3939881e+02f,3.4015357e+02f,3.4090881e+02f,3.4166452e+02f,
3.4242071e+02f,3.4317762e+02f,3.4393524e+02f,3.4469310e+02f,3.4545167e+02f,3.4621095e+02f,3.4697048e+02f,3.4773071e+02f,3.4849167e+02f,3.4925286e+02f,3.5001476e+02f,3.5077738e+02f,3.5154024e+02f,3.5230381e+02f,3.5306810e+02f,3.5383262e+02f,3.5459786e+02f,3.5536357e+02f,3.5613000e+02f,3.5689690e+02f,3.5766429e+02f,3.5843214e+02f,3.5920048e+02f,3.5996952e+02f,3.6073929e+02f,3.6150929e+02f,3.6228000e+02f,3.6305095e+02f,3.6382286e+02f,3.6459500e+02f,3.6536786e+02f,3.6614095e+02f,3.6691476e+02f,3.6768929e+02f,3.6846405e+02f,3.6923952e+02f,3.7001548e+02f,3.7079190e+02f,3.7156881e+02f,3.7234643e+02f,3.7312429e+02f,3.7390286e+02f,3.7468190e+02f,3.7546143e+02f,3.7624143e+02f,3.7702214e+02f,3.7780310e+02f,3.7858476e+02f,3.7936690e+02f,3.8014929e+02f,
3.8093238e+02f,3.8171595e+02f,3.8250000e+02f,3.8328476e+02f,3.8406976e+02f,3.8485524e+02f,3.8564143e+02f,3.8642786e+02f,3.8721476e+02f,3.8800238e+02f,3.8879024e+02f,3.8957881e+02f,3.9036762e+02f,3.9115714e+02f,3.9194690e+02f,3.9273738e+02f,3.9352810e+02f,3.9431929e+02f,3.9511119e+02f,3.9590333e+02f,3.9669595e+02f,3.9748905e+02f,3.9828262e+02f,3.9907643e+02f,3.9987095e+02f,4.0066595e+02f,4.0146119e+02f,4.0225690e+02f,4.0305310e+02f,4.0384976e+02f,4.0464667e+02f,4.0544429e+02f,4.0624214e+02f,4.0704048e+02f,4.0783929e+02f,4.0863833e+02f,4.0943786e+02f,4.1023786e+02f,4.1103810e+02f,4.1183905e+02f,4.1264000e+02f,4.1344167e+02f,4.1424357e+02f,4.1504595e+02f,4.1584857e+02f,4.1665167e+02f,4.1745524e+02f,4.1825905e+02f,4.1906310e+02f,4.1986786e+02f,
4.2067262e+02f,4.2147786e+02f,4.2228357e+02f,4.2308952e+02f,4.2389595e+02f,4.2470262e+02f,4.2550952e+02f,4.2631690e+02f,4.2712452e+02f,4.2793262e+02f,4.2874071e+02f,4.2954952e+02f,4.3035833e+02f,4.3116762e+02f,4.3197714e+02f,4.3278690e+02f,4.3359690e+02f,4.3440738e+02f,4.3521810e+02f,4.3602905e+02f,4.3684024e+02f,4.3765167e+02f,4.3846333e+02f,4.3927548e+02f,4.4008762e+02f,4.4090024e+02f,4.4171286e+02f,4.4252595e+02f,4.4333905e+02f,4.4415238e+02f,4.4496595e+02f,4.4578000e+02f,4.4659405e+02f,4.4740810e+02f,4.4822262e+02f,4.4903714e+02f,4.4985214e+02f,4.5066690e+02f,4.5148214e+02f,4.5229738e+02f,4.5311286e+02f,4.5392857e+02f,4.5474429e+02f,4.5556024e+02f,4.5637619e+02f,4.5719238e+02f,4.5800857e+02f,4.5882500e+02f,4.5964143e+02f,4.6045810e+02f,
4.6127476e+02f,4.6209143e+02f,4.6290833e+02f,4.6372524e+02f,4.6454214e+02f,4.6535905e+02f,4.6617619e+02f,4.6699310e+02f,4.6781024e+02f,4.6862738e+02f,4.6944452e+02f,4.7026167e+02f,4.7107881e+02f,4.7189595e+02f,4.7271310e+02f,4.7353024e+02f,4.7434714e+02f,4.7516429e+02f,4.7598119e+02f,4.7679810e+02f,4.7761476e+02f,4.7843167e+02f,4.7924833e+02f,4.8006476e+02f,4.8088119e+02f,4.8169762e+02f,4.8251381e+02f,4.8332976e+02f,4.8414571e+02f,4.8496167e+02f,4.8577714e+02f,4.8659262e+02f,4.8740810e+02f,4.8822310e+02f,4.8903786e+02f,4.8985262e+02f,4.9066714e+02f,4.9148143e+02f,4.9229548e+02f,4.9310905e+02f,4.9392262e+02f,4.9473595e+02f,4.9554881e+02f,4.9636143e+02f,4.9717381e+02f,4.9798595e+02f,4.9879762e+02f,4.9960905e+02f,5.0042000e+02f,5.0123071e+02f,
5.0204095e+02f,5.0285095e+02f,5.0366048e+02f,5.0446976e+02f,5.0527857e+02f,5.0608690e+02f,5.0689476e+02f,5.0770214e+02f,5.0850929e+02f,5.0931571e+02f,5.1012190e+02f,5.1092738e+02f,5.1173238e+02f,5.1253714e+02f,5.1334095e+02f,5.1414452e+02f,5.1494738e+02f,5.1575000e+02f,5.1655167e+02f,5.1735286e+02f,5.1815357e+02f,5.1895357e+02f,5.1975286e+02f,5.2055167e+02f,5.2134976e+02f,5.2214714e+02f,5.2294405e+02f,5.2374000e+02f,5.2453548e+02f,5.2533024e+02f,5.2612405e+02f,5.2691738e+02f,5.2770976e+02f,5.2850143e+02f,5.2929238e+02f,5.3008238e+02f,5.3087190e+02f,5.3166024e+02f,5.3244786e+02f,5.3323476e+02f,5.3402071e+02f,5.3480595e+02f,5.3559000e+02f,5.3637333e+02f,5.3715571e+02f,5.3793738e+02f,5.3871786e+02f,5.3949738e+02f,5.4027595e+02f,5.4105381e+02f,
5.4183048e+02f,5.4260595e+02f,5.4338071e+02f,5.4415429e+02f,5.4492690e+02f,5.4569833e+02f,5.4646857e+02f,5.4723810e+02f,5.4800619e+02f,5.4877333e+02f,5.4953929e+02f,5.5030405e+02f,5.5106786e+02f,5.5183024e+02f,5.5259167e+02f,5.5335167e+02f,5.5411048e+02f,5.5486810e+02f,5.5562452e+02f,5.5637976e+02f,5.5713357e+02f,5.5788619e+02f,5.5863762e+02f,5.5938762e+02f,5.6013619e+02f,5.6088357e+02f,5.6162952e+02f,5.6237405e+02f,5.6311738e+02f,5.6385905e+02f,5.6459952e+02f,5.6533833e+02f,5.6607595e+02f,5.6681214e+02f,5.6754667e+02f,5.6827976e+02f,5.6901143e+02f,5.6974167e+02f,5.7047024e+02f,5.7119714e+02f,5.7192262e+02f,5.7264667e+02f,5.7336905e+02f,5.7408976e+02f,5.7480905e+02f,5.7552667e+02f,5.7624262e+02f,5.7695690e+02f,5.7766952e+02f,5.7838048e+02f,
5.7908976e+02f,5.7979714e+02f,5.8050310e+02f,5.8120714e+02f,5.8190952e+02f,5.8261024e+02f,5.8330905e+02f,5.8400619e+02f,5.8470143e+02f,5.8539500e+02f,5.8608667e+02f,5.8684334e+02f,5.8754521e+02f,5.8815071e+02f,5.8883500e+02f,5.8951762e+02f,5.9019810e+02f,5.9087667e+02f,5.9155333e+02f,5.9222810e+02f,5.9290095e+02f,5.9357190e+02f,5.9424095e+02f,5.9490786e+02f,5.9557286e+02f,5.9623571e+02f,5.9689667e+02f,5.9755571e+02f,5.9821262e+02f,5.9886738e+02f,5.9952024e+02f,6.0017095e+02f,6.0081952e+02f,6.0146619e+02f,6.0211048e+02f,6.0275286e+02f,6.0339310e+02f,6.0403119e+02f,6.0466714e+02f,6.0530095e+02f,6.0593262e+02f,6.0656214e+02f,6.0718929e+02f,6.0781429e+02f,6.0843714e+02f,6.0905786e+02f,6.0967643e+02f,6.1029262e+02f,6.1059784e+02f,6.1090643e+02f,
6.1157939e+02f};

/*=======================================================================
*
* Name: UInt32 project3DPointToImage(Point3D_f *xyzc, Point3D_f *xyd)
*
* Description: given point in camera coordinates, find pixel location
* 			    in image
*
=======================================================================*/
UInt32 project3DPointToImage(Point3D_f *xyzc, Point3D_f *xyd)
{
	UInt32 status = 0;

	/*check if point is behind camera*/
	if (xyzc->z <= 0)
		return 1;

	Flouble rc = SQRT(xyzc->x*xyzc->x + xyzc->y*xyzc->y);
	Flouble rcInv = 1/(rc+FLOUBLE_EPSILON);
	Flouble theta = ATAN(rc/xyzc->z);

	/*Look-up table */
	Flouble ind = theta/ldcLUT_U2D_step;
	if (ind >= ldcLUT_U2D_length-1)
		return 1;
	Int32 N = (Int32)ind;
	Flouble indMinN = ind - (Flouble)N;
	Flouble rd = (1.0f - indMinN)*ldcLUT_U2D_table[N] + indMinN * ldcLUT_U2D_table[N + 1];

	xyd->x = (Flouble)ldcLUT_distortionCenters[0] + rd*xyzc->x*rcInv;
	xyd->y = (Flouble)ldcLUT_distortionCenters[1] + rd*xyzc->y*rcInv;
	xyd->z = 0;

	return status;

}



